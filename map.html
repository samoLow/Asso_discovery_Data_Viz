<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
	<script   src="https://code.jquery.com/jquery-3.3.1.min.js"   integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="   crossorigin="anonymous"></script>
    <meta charset="UTF-8">
	<link rel="stylesheet" href="style.css">
	<title>Map</title>
    <link href="https://fonts.googleapis.com/css?family=Secular+One" rel="stylesheet">
    <style>
        h2{
            color:#333;
            font-family: 'Secular One', sans-serif;
            font-size: 1.5em;
        }
    </style>
</head>
<body>

	<!-- Les Selecteurs -->
	<div id="selectors" style="width:10%;height:390px;border-radius:5px;display: inline-block;">
		<img id="selector-eco" src="feuille.png" style="width:100%;height:33%;background-color:rgba(118,226,243,0.2);text-align:center;border-radius:5px 5px 0px 0px;">
		<img id="selector-animal" src="coeur.png" style="width:100%;height:33%;background-color:rgba(118,226,243,0.2);text-align:center;">
		<img id="selector-social" src="chien.png" style="width:100%;height:34%;background-color:rgba(118,226,243,0.2);text-align:center;border-radius:0px 0px 5px 5px;;">
	</div>

	<!-- La carte -->
	<div id="map" style="width:90%;height:390px;display: inline-block;float:right;"></div>

	<!-- Bloc en dessous des selecteurs -->
	<div id="whiteblock" style="width:9%;height:300px;background-color: white;display: inline-block;"></div>

	<!-- Bloc d'information sur l'asso cliquÃ©e -->
	<div id="informations" style="width:90%;height:100%;display: inline-block;margin-bottom:100px;float: right;border:1px black solid;border-radius:10px;">

		<!-- LIGNE 1 -->
		<div style="width:50%;background-color:rgba(118,226,243,0.2);display: inline-block;">
			<h2 style="padding: 5px 20px;">Nom :</h2>
			<p id="nom" style="padding: 5px 20px;">Texte</p>
		</div>
        <div style="width:50%;background-color:rgba(118,226,243,0.2);display: inline-block;float:right;">
			<h2 style="padding: 5px 20px;">Date :</h2>
			<p id="date" style="padding: 5px 20px;">Texte</p>
		</div>

        <!-- LIGNE 2 -->
		<div style="width:50%;display: inline-block;">
			<h2 style="padding: 5px 20px;">Adresse de l'Asso :</h2>
			<p id="adresse" style="padding: 5px 20px;">Texte</p>
		</div>
        <div style="width:50%;display: inline-block;float:right;">
			<h2 style="padding: 5px 20px;">Type :</h2>
			<p id="type" style="padding: 5px 20px;">Texte</p>
		</div>

        <!-- LIGNE 3 -->
		<div style="width:100%;background-color:rgba(118,226,243,0.2);display: inline-block;">
			<h2 style="padding: 5px 20px;">Description :</h2>
			<p id="description" style="padding: 5px 20px;">Texte</p>
		</div>

        <!-- LIGNE 4 -->
		<div style="width:100%;display: inline-block;">
			<h2 style="padding: 5px 20px;">Le site de l'Asso</h2>
			<p id="urltoasso" style="padding: 5px 20px;">Texte</p>
		</div>

        <!-- LIGNE 5 -->
		<div style="width:100%;background-color:rgba(118,226,243,0.2);display: inline-block;">
			<h2 style="padding: 5px 20px;">Notre article</h2>
			<p id="urltooursite" style="padding: 5px 20px;">Texte</p>
		</div>

	</div>

	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

    var asso_arr =[];
    var url_site_ad = "https://www.assodiscovery.fr";
    var png_ad_ani = "https://www.assodiscovery.fr/wp-content/uploads/2018/11/coeur-01.png";
    var png_ad_soc = "https://www.assodiscovery.fr/wp-content/uploads/2018/11/coeur-01.png";
    var png_ad_eco = "https://www.assodiscovery.fr/wp-content/uploads/2018/11/coeur-01.png";
    var png_ani = "https://www.assodiscovery.fr/wp-content/uploads/2018/11/coeur-01.png";
    var png_soc = "https://www.assodiscovery.fr/wp-content/uploads/2018/11/coeur-01.png";
    var png_eco = "https://www.assodiscovery.fr/wp-content/uploads/2018/11/coeur-01.png";
    var image_test = "src/dot_eco-01.png"
    var data = undefined;
    var URL = "https://docs.google.com/spreadsheets/d/1kWMkDglBeO6uUuCnJWu9_-r9IeKE4EID160i2CGhV8M";
    URL += "/pub?single=true&output=csv";
    var color_cust = ["red", "#FDA900", "green"];

    function initMap() {


        d3.csv(URL, function (error, data) {
            //1. load data and throw error if there is one
            data.forEach(function (d) {
                d.latitude = +d.latitude;
                d.longitude = +d.longitude;
                d.taille = +d.taille;
                d.temps = +d.temps;
                d.creation = +d.creation;
                var asso = {
                    nom: d.nom,
                    date: d.creation,
                    description: d.description,
                    type: d.cause,
                    taille: d.taille,
                    id_temps: d.temps,
                    url_site: d.lien_site,
                    lien_ass_d: d.lien_ass_d,
                    latitude: d.latitude,
                    longitude: d.longitude,
                    adresse: d.adresse,
                    visite: d.visite
                };
                asso_arr.push(asso);
            });

            //2. define reset and draw functions

            //default to location - declare variables, reset_data and draw charts


            new_draw_map(data);

            function new_draw_map(data) {

                //1. Set the list title
                //document.getElementById('map_title').innerHTML = "Map for selected " + search_opt.toUpperCase();

                //2. Apply filters

                var my_data = data.filter(function(d){
                    return !isNaN(d.taille);
                }).filter(function(d){
                    return !isNaN(d.latitude);
                });
                var r = d3.scaleLinear().domain([0, 2000]).range([5, 15]);

                var bound = new google.maps.LatLngBounds();
                var long;
                var lat;
                for (var m in my_data) {
                    long = +my_data[m].longitude;
                    lat = +my_data[m].latitude;
                    if (isNaN(my_data[m].longitude)) {
                        //my_data.splice(m, 1)
                    } else {
                        bound.extend(new google.maps.LatLng(lat, long));
                    }
                }
                var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;

                d3.selectAll('#map')
                    .attr("width", width - 200);

                // Create the Google Map w/o poi
                var map = new google.maps.Map(d3.select("#map").node(), {
                    zoom: 14,
                    center: new google.maps.LatLng(45.7642037, 4.8376517),
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#f5f5f5"
                                }
                            ]
                        },
                        {
                            "elementType": "labels.icon",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#616161"
                                }
                            ]
                        },
                        {
                            "elementType": "labels.text.stroke",
                            "stylers": [
                                {
                                    "color": "#f5f5f5"
                                }
                            ]
                        },
                        {
                            "featureType": "administrative",
                            "stylers": [
                                {
                                    "color": "#323333"
                                },
                                {
                                    "weight": 0.5
                                }
                            ]
                        },
                        {
                            "featureType": "administrative.land_parcel",
                            "elementType": "labels",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "administrative.land_parcel",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#bdbdbd"
                                }
                            ]
                        },
                        {
                            "featureType": "administrative.locality",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "administrative.locality",
                            "elementType": "geometry.fill",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "administrative.neighborhood",
                            "stylers": [
                                {
                                    "visibility": "simplified"
                                }
                            ]
                        },
                        {
                            "featureType": "administrative.neighborhood",
                            "elementType": "labels.icon",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "administrative.neighborhood",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#606b75"
                                }
                            ]
                        },
                        {
                            "featureType": "landscape",
                            "elementType": "geometry.stroke",
                            "stylers": [
                                {
                                    "color": "#660000"
                                }
                            ]
                        },
                        {
                            "featureType": "poi",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#eeeeee"
                                }
                            ]
                        },
                        {
                            "featureType": "poi",
                            "elementType": "labels.text",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#757575"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.attraction",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.business",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.government",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.medical",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.park",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#e5e5e5"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.park",
                            "elementType": "labels.text",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.park",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#9e9e9e"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.place_of_worship",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.school",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "poi.sports_complex",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "road",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#ffffff"
                                }
                            ]
                        },
                        {
                            "featureType": "road.arterial",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#757575"
                                },
                                {
                                    "visibility": "simplified"
                                }
                            ]
                        },
                        {
                            "featureType": "road.arterial",
                            "elementType": "labels.text.stroke",
                            "stylers": [
                                {
                                    "color": "#cbced3"
                                }
                            ]
                        },
                        {
                            "featureType": "road.highway",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#dadada"
                                }
                            ]
                        },
                        {
                            "featureType": "road.highway",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#616161"
                                }
                            ]
                        },
                        {
                            "featureType": "road.local",
                            "elementType": "labels",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "road.local",
                            "elementType": "labels.text",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "road.local",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#9e9e9e"
                                },
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "transit.line",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#e5e5e5"
                                }
                            ]
                        },
                        {
                            "featureType": "transit.station",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#eeeeee"
                                }
                            ]
                        },
                        {
                            "featureType": "transit.station.airport",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "transit.station.bus",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        },
                        {
                            "featureType": "water",
                            "elementType": "geometry",
                            "stylers": [
                                {
                                    "color": "#c9c9c9"
                                }
                            ]
                        },
                        {
                            "featureType": "water",
                            "elementType": "labels.text.fill",
                            "stylers": [
                                {
                                    "color": "#f4f4f4"
                                }
                            ]
                        }
                    ]
                });


                //map.fitBounds(bound);

                var overlay = new google.maps.OverlayView();

                // Add the container when the overlay is added to the map.
                overlay.onAdd = function () {
                    var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
                        .attr("class", "effective");

                    // Draw each marker as a separate SVG element.
                    // We could use a single SVG, but what size would it have?
                    overlay.draw = function () {
                        var projection = this.getProjection(),
                            padding = 5;

                        var tooltip = d3.select("body")
                            .append("div")
                            .attr("class", "tooltip_map")
                            .html("");

                        var marker = layer.selectAll("svg")
                            .data(my_data, function (d) {
                                return d.nom;
                            })
                            .each(transform) // update existing markers
                            .enter().append("svg")
                            .attr("id", function (d, i) {
                                return "marker_" + i;
                            })
                            .attr("class", "marker")
                            .each(transform);


                        // Add a circle.
                        marker.append("circle")
                            .attr("r", function (d) {
                                //console.log(d.taille);
                                return r(d.taille);
                            })
                            .attr("fill", function (d) {
                                if (d.cause === "ecologie") {
                                    return color_cust[2];
                                } else if (d.cause === "sociale") {
                                    return color_cust[0];
                                } else if (d.cause == "animale") {
                                    return color_cust[1];
                                }
                            })
                            .attr("cx", padding + 5)
                            .attr("cy", padding + 5)
                            .on("mouseover", function (d) {
                                //sets tooltip.  t_text = content in html
                                tooltip.style("visibility", "hidden");
                                t_text = d.nom;
                                tooltip.html(t_text);
                                d3.select(this).style("cursor", "pointer");
                                tooltip.style("visibility", "visible");
                                tooltip.style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px");
                            })
                            .on("mousemove", function () {

                            })
                            .on("mouseout", function () {
                                tooltip.style("visibility", "hidden");
                                d3.select(this).style("cursor", "default");


                            })
                            .on("click", function (d) {
                                writte_info("nom", d.nom);
                                writte_info("description", d.description);
                                writte_info("date_crea", d.creation);
                                writte_info("adresse", d.adresse);






                            });

                        //.style("stroke", "none")
                        function transform(d) {
                            d = new google.maps.LatLng(+d.latitude, +d.longitude);
                            d = projection.fromLatLngToDivPixel(d);
                            return d3.select(this)
                                .style("left", (d.x - padding) + "px")
                                .style("top", (d.y - padding) + "px");
                        }
                    };
                };

                // Bind our overlay to the map
                overlay.setMap(map);


            }


            d3.selectAll(".marker")
                .filter(function () {
                    if (nfilter === 0) {
                        return true;
                    }
                }).select("circle").transition().duration(1000).attr("r", 6);

            d3.selectAll(".marker")
                .filter(function (d) {
                    var nmatch = 0;
                    $.each(all_options, function (k) {
                        if (all_options[k].contains(d[k])) {
                            nmatch += 1;
                        }
                    });
                    if (nmatch === nfilter && nfilter > 0) {
                        return true
                    }
                }).select("circle").transition().duration(1000).attr("r", 9);

            d3.selectAll(".marker")
                .filter(function (d) {
                    var nmatch = 0;
                    $.each(all_options, function (k) {
                        if (all_options[k].contains(d[k])) {
                            nmatch += 1;
                        }
                    });
                    if (nmatch !== nfilter && nfilter > 0) {
                        return true
                    }
                }).select("circle").transition().duration(1000).attr("r", 0);


            d3.selectAll(".marker")
                .filter(function (d) {
                    if (nfilter === 0) {
                        return 0;
                    } else {
                        var nmatch = 0;
                        $.each(all_options, function (k) {
                            if (all_options[k].contains(d[k])) {
                                nmatch += 1;
                            }
                        });
                        return nmatch === nfilter;
                    }
                })
                .raise();


        })
        ;

    }
    function writte_info(id_element, property){
        $("#" + id_element).html("");

        $("#" + id_element).append(property);
    }


</script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqBUfDr3Dbyn2gatzEeyLsfKtsrUNZkxs&callback=initMap"></script>
<script></script>
</body>
</html>


